/********* Begin Procedure Script ************/ 

BEGIN 



   var_out = 
SELECT "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "YEAR", "MONTH", "DAY", "FECHA", "CALMONTH",
 CASE WHEN "CATEGORIA"='TELEFONIA FIJA' THEN 'TELEFONIA' ELSE "CATEGORIA" END AS "CATEGORIA",
 GANANCIA_RGU, RGU_PROMEDIO, NO_DX_3M, GANANCIA_RGU_PM, RGU_PROMEDIO_PM, NO_DX_3M_PM, NO_RGU, NO_RGU_PM, 
 NO_CTES_INI_MES, NO_CTES_INI_MES_PM,
 NO_CTES_FIN_MES, NO_CTES_FIN_MES_PM, NO_RGU_FIN_MES, NO_RGU_FIN_MES_PM, NO_RGU_INI_MES, NO_RGU_INI_MES_PM
FROM(
 SELECT "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "YEAR", "MONTH", "DAY", "FECHA", "CALMONTH", "CATEGORIA",
   "NO_RGU"-LAG("NO_RGU",1) OVER (PARTITION BY EMPRESA, TIPO, REGION, SUBREGION, HUB, CIUDAD, CATEGORIA ORDER BY FECHA ASC) AS GANANCIA_RGU,
   SUM(NO_RGU_INI_MES) OVER (PARTITION BY EMPRESA, TIPO, REGION, SUBREGION, HUB, CIUDAD, CATEGORIA)/2+"NO_RGU"/2 AS RGU_PROMEDIO, 
   SUM(NO_DX_3M) OVER (PARTITION BY EMPRESA, TIPO, REGION, SUBREGION, HUB, CIUDAD, CATEGORIA, CALMONTH ORDER BY FECHA ASC) AS NO_DX_3M,
   NULL AS GANANCIA_RGU_PM, NULL AS RGU_PROMEDIO_PM, NULL AS NO_DX_3M_PM, "NO_RGU", null as "NO_RGU_PM",
   SUM(NO_CTES_INI_MES) OVER (PARTITION BY EMPRESA, TIPO, REGION, SUBREGION, HUB, CIUDAD, CATEGORIA, CALMONTH) AS NO_CTES_INI_MES, NULL AS NO_CTES_INI_MES_PM,
   SUM(NO_CTES_FIN_MES) OVER (PARTITION BY EMPRESA, TIPO, REGION, SUBREGION, HUB, CIUDAD, CATEGORIA, CALMONTH) AS NO_CTES_FIN_MES, NULL AS NO_CTES_FIN_MES_PM,
   SUM(NO_RGU_FIN_MES) OVER (PARTITION BY EMPRESA, TIPO, REGION, SUBREGION, HUB, CIUDAD, CATEGORIA, CALMONTH) AS NO_RGU_FIN_MES, NULL AS NO_RGU_FIN_MES_PM,
   SUM(NO_RGU_INI_MES) OVER (PARTITION BY EMPRESA, TIPO, REGION, SUBREGION, HUB, CIUDAD, CATEGORIA, CALMONTH) AS NO_RGU_INI_MES, NULL AS NO_RGU_INI_MES_PM,
   CASE WHEN CALMONTH=:I_CALMONTH THEN 0 ELSE 1 END AS QUITAR
 FROM (
   SELECT sum(NO_RGU) AS NO_RGU, sum(NO_RGU_INI_MES) AS NO_RGU_INI_MES, sum(NO_DX_3M) AS NO_DX_3M,
     EMPRESA, CASE 
       WHEN COALESCE(REGION,'ND')='ND' AND EMPRESA='CABLEVISION' THEN 'METROPOLITANA'
       WHEN COALESCE(REGION,'ND')='ND' AND EMPRESA='CABLEMAS' THEN 'INTERIOR'
       WHEN COALESCE(REGION,'ND')='ND' AND EMPRESA='TVI' THEN 'NORESTE'
       ELSE REGION END AS REGION, 
     COALESCE(SUBREGION,'ND') AS SUBREGION,  COALESCE(HUB,'ND') AS HUB,  COALESCE(CIUDAD,'ND') AS CIUDAD, YEAR, MONTH, DAY, FECHA, CALMONTH, CALMONTH2,
     CASE WHEN CATEGORIA='TELEFONIA FIJA' THEN 'TELEFONIA' ELSE CATEGORIA END AS CATEGORIA, TIPO, 
     SUM(NO_CTES_INI_MES) AS NO_CTES_INI_MES,
     SUM(NO_CTES_FIN_MES) AS NO_CTES_FIN_MES, SUM(NO_RGU_FIN_MES) AS NO_RGU_FIN_MES
   FROM(
     SELECT sum(NO_RGU) AS NO_RGU, sum(NO_RGU_INI_MES) AS NO_RGU_INI_MES, sum(NO_DX_3M) AS NO_DX_3M,
       EMPRESA, REGION, SUBREGION, HUB, CIUDAD, YEAR, MONTH, DAY, FECHA, CALMONTH, CALMONTH2, CATEGORIA, TIPO, 
       SUM(NO_CTES_INI_MES) AS NO_CTES_INI_MES,
       SUM(NO_CTES_FIN_MES) AS NO_CTES_FIN_MES, SUM(NO_RGU_FIN_MES) AS NO_RGU_FIN_MES
     FROM "_SYS_BIC"."T.REPORTES02/ANA_RGU_REPORTES_02"
     WHERE (CALMONTH=:I_CALMONTH OR FECHA=(SELECT LAST_DAY(ADD_MONTHS(MIN(DATE_SQL),-1)) 
     FROM "_SYS_BIC"."T/ATT_TIME_HANA" WHERE CALMONTH=:I_CALMONTH)) --AND CATEGORIA IS NOT NULL
     GROUP BY EMPRESA, REGION, SUBREGION, HUB, CIUDAD, YEAR, MONTH, DAY, FECHA, CALMONTH, CALMONTH2, CATEGORIA, TIPO
     UNION ALL
     SELECT 0 AS NO_RGU, 0 AS NO_RGU_INI_MES, 0 AS NO_DX_3M,
       EMPRESA, REGION, SUBREGION, HUB, CIUDAD, YEAR, MONTH, DAY, FECHA, CALMONTH, CALMONTH2, CATEGORIA, TIPO, 
       0 AS NO_CTES_INI_MES,
       0 AS NO_CTES_FIN_MES, 0 AS NO_RGU_FIN_MES
     FROM
     (
       SELECT DISTINCT EMPRESA, REGION, SUBREGION, HUB, CIUDAD, CATEGORIA, TIPO
       FROM "_SYS_BIC"."T.REPORTES02/ANA_RGU_REPORTES_02"
       WHERE (CALMONTH=:I_CALMONTH OR FECHA=(SELECT LAST_DAY(ADD_MONTHS(MIN(DATE_SQL),-1)) FROM "_SYS_BIC"."T/ATT_TIME_HANA" WHERE CALMONTH=:I_CALMONTH)) --AND CATEGORIA IS NOT NULL
       GROUP BY EMPRESA, REGION, SUBREGION, HUB, CIUDAD, YEAR, MONTH, DAY, FECHA, CALMONTH, CALMONTH2, CATEGORIA, TIPO
     ) A, (
       SELECT DISTINCT YEAR, MONTH, DAY, FECHA, CALMONTH, CALMONTH2
       FROM "_SYS_BIC"."T.REPORTES02/ANA_RGU_REPORTES_02"
       WHERE (CALMONTH=:I_CALMONTH OR FECHA=(SELECT LAST_DAY(ADD_MONTHS(MIN(DATE_SQL),-1)) FROM "_SYS_BIC"."T/ATT_TIME_HANA" WHERE CALMONTH=:I_CALMONTH))
       GROUP BY EMPRESA, REGION, SUBREGION, HUB, CIUDAD, YEAR, MONTH, DAY, FECHA, CALMONTH, CALMONTH2, CATEGORIA, TIPO
     ) B
     
   )
   GROUP BY EMPRESA, CASE 
       WHEN COALESCE(REGION,'ND')='ND' AND EMPRESA='CABLEVISION' THEN 'METROPOLITANA'
       WHEN COALESCE(REGION,'ND')='ND' AND EMPRESA='CABLEMAS' THEN 'INTERIOR'
       WHEN COALESCE(REGION,'ND')='ND' AND EMPRESA='TVI' THEN 'NORESTE'
       ELSE REGION END,
     COALESCE(SUBREGION,'ND'), COALESCE(HUB,'ND'), COALESCE(CIUDAD,'ND'), YEAR, MONTH, DAY, FECHA, CALMONTH, CALMONTH2, 
     CASE WHEN CATEGORIA='TELEFONIA FIJA' THEN 'TELEFONIA' ELSE CATEGORIA END, TIPO
 )
 UNION ALL
 SELECT "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "YEAR", "MONTH", "DAY", "FECHA", "CALMONTH", "CATEGORIA",
   NULL AS GANANCIA_RGU, NULL AS RGU_PROMEDIO, NULL AS NO_DX_3M,
   "NO_RGU"-LAG("NO_RGU",1) OVER (PARTITION BY EMPRESA, TIPO, REGION, SUBREGION, HUB, CIUDAD, CATEGORIA ORDER BY FECHA ASC) AS GANANCIA_RGU_PM, 
   SUM(NO_RGU_INI_MES) OVER (PARTITION BY EMPRESA, TIPO, REGION, SUBREGION, HUB, CIUDAD, CATEGORIA)/2+"NO_RGU"/2 AS RGU_PROMEDIO_PM, 
   SUM(NO_DX_3M) OVER (PARTITION BY EMPRESA, TIPO, REGION, SUBREGION, HUB, CIUDAD, CATEGORIA, CALMONTH ORDER BY FECHA ASC) AS NO_DX_3M_PM,
   NULL AS "NO_RGU", "NO_RGU" as "NO_RGU_PM",
   NULL AS NO_CTES_INI_MES, SUM(NO_CTES_INI_MES) OVER (PARTITION BY EMPRESA, TIPO, REGION, SUBREGION, HUB, CIUDAD, CATEGORIA, CALMONTH) AS NO_CTES_INI_MES_PM,
   NULL AS NO_CTES_FIN_MES, SUM(NO_CTES_FIN_MES) OVER (PARTITION BY EMPRESA, TIPO, REGION, SUBREGION, HUB, CIUDAD, CATEGORIA, CALMONTH) AS NO_CTES_FIN_MES_PM,
   NULL AS NO_RGU_FIN_MES, SUM(NO_RGU_FIN_MES) OVER (PARTITION BY EMPRESA, TIPO, REGION, SUBREGION, HUB, CIUDAD, CATEGORIA, CALMONTH) AS NO_RGU_FIN_MES_PM,
   NULL AS NO_RGU_INI_MES, SUM(NO_RGU_INI_MES) OVER (PARTITION BY EMPRESA, TIPO, REGION, SUBREGION, HUB, CIUDAD, CATEGORIA, CALMONTH) AS NO_RGU_INI_MES_PM,
   CASE WHEN CALMONTH2=:I_CALMONTH THEN 0 ELSE 1 END AS QUITAR
 FROM (
   SELECT sum(NO_RGU) AS NO_RGU, sum(NO_RGU_INI_MES) AS NO_RGU_INI_MES, sum(NO_DX_3M) AS NO_DX_3M,
     EMPRESA, CASE 
       WHEN COALESCE(REGION,'ND')='ND' AND EMPRESA='CABLEVISION' THEN 'METROPOLITANA'
       WHEN COALESCE(REGION,'ND')='ND' AND EMPRESA='CABLEMAS' THEN 'INTERIOR'
       WHEN COALESCE(REGION,'ND')='ND' AND EMPRESA='TVI' THEN 'NORESTE'
       ELSE REGION END AS REGION, 
     COALESCE(SUBREGION,'ND') AS SUBREGION,  COALESCE(HUB,'ND') AS HUB,  COALESCE(CIUDAD,'ND') AS CIUDAD, YEAR, MONTH, DAY, FECHA, CALMONTH, CALMONTH2, 
     CASE WHEN CATEGORIA='TELEFONIA FIJA' THEN 'TELEFONIA' ELSE CATEGORIA END AS CATEGORIA, TIPO, 
     SUM(NO_CTES_INI_MES) AS NO_CTES_INI_MES,
     SUM(NO_CTES_FIN_MES) AS NO_CTES_FIN_MES, SUM(NO_RGU_FIN_MES) AS NO_RGU_FIN_MES
   FROM(
     SELECT sum(NO_RGU) AS NO_RGU, sum(NO_RGU_INI_MES) AS NO_RGU_INI_MES, sum(NO_DX_3M) AS NO_DX_3M,
       EMPRESA, REGION, SUBREGION, HUB, CIUDAD, YEAR, MONTH, DAY, FECHA, CALMONTH, CALMONTH2, CATEGORIA, TIPO, 
       SUM(NO_CTES_INI_MES) AS NO_CTES_INI_MES,
       SUM(NO_CTES_FIN_MES) AS NO_CTES_FIN_MES, SUM(NO_RGU_FIN_MES) AS NO_RGU_FIN_MES
     FROM "_SYS_BIC"."T.REPORTES02/ANA_RGU_REPORTES_02"
     WHERE (CALMONTH2=:I_CALMONTH OR FECHA=(SELECT LAST_DAY(ADD_MONTHS(MIN(DATE_SQL),-2)) 
     FROM "_SYS_BIC"."T/ATT_TIME_HANA" WHERE CALMONTH=:I_CALMONTH)) --AND CATEGORIA IS NOT NULL
     GROUP BY EMPRESA, REGION, SUBREGION, HUB, CIUDAD, YEAR, MONTH, DAY, FECHA, CALMONTH, CALMONTH2, CATEGORIA, TIPO
     UNION ALL
     SELECT 0 AS NO_RGU, 0 AS NO_RGU_INI_MES, 0 AS NO_DX_3M,
       EMPRESA, REGION, SUBREGION, HUB, CIUDAD, YEAR, MONTH, DAY, FECHA, CALMONTH, CALMONTH2, CATEGORIA, TIPO, 
       0 AS NO_CTES_INI_MES,
       0 AS NO_CTES_FIN_MES, 0 AS NO_RGU_FIN_MES
     FROM
     (
       SELECT DISTINCT EMPRESA, REGION, SUBREGION, HUB, CIUDAD, CATEGORIA, TIPO
       FROM "_SYS_BIC"."T.REPORTES02/ANA_RGU_REPORTES_02"
       WHERE (CALMONTH2=:I_CALMONTH OR FECHA=(SELECT LAST_DAY(ADD_MONTHS(MIN(DATE_SQL),-2)) 
       FROM "_SYS_BIC"."T/ATT_TIME_HANA" WHERE CALMONTH=:I_CALMONTH)) --AND CATEGORIA IS NOT NULL
       GROUP BY EMPRESA, REGION, SUBREGION, HUB, CIUDAD, YEAR, MONTH, DAY, FECHA, CALMONTH, CALMONTH2, CATEGORIA, TIPO
     ) A, (
       SELECT DISTINCT YEAR, MONTH, DAY, FECHA, CALMONTH, CALMONTH2
       FROM "_SYS_BIC"."T.REPORTES02/ANA_RGU_REPORTES_02"
       WHERE (CALMONTH2=:I_CALMONTH OR FECHA=(SELECT LAST_DAY(ADD_MONTHS(MIN(DATE_SQL),-2)) FROM "_SYS_BIC"."T/ATT_TIME_HANA" WHERE CALMONTH=:I_CALMONTH))
       GROUP BY EMPRESA, REGION, SUBREGION, HUB, CIUDAD, YEAR, MONTH, DAY, FECHA, CALMONTH, CALMONTH2, CATEGORIA, TIPO
     ) B
     
   )
   GROUP BY EMPRESA, CASE 
       WHEN COALESCE(REGION,'ND')='ND' AND EMPRESA='CABLEVISION' THEN 'METROPOLITANA'
       WHEN COALESCE(REGION,'ND')='ND' AND EMPRESA='CABLEMAS' THEN 'INTERIOR'
       WHEN COALESCE(REGION,'ND')='ND' AND EMPRESA='TVI' THEN 'NORESTE'
       ELSE REGION END,
     COALESCE(SUBREGION,'ND'), COALESCE(HUB,'ND'), COALESCE(CIUDAD,'ND'), YEAR, MONTH, DAY, FECHA, CALMONTH, CALMONTH2, 
     CASE WHEN CATEGORIA='TELEFONIA FIJA' THEN 'TELEFONIA' ELSE CATEGORIA END, TIPO
 )
)
WHERE QUITAR=0;

END /********* End Procedure Script ************/