 
 /********* Begin Procedure Script ************/ 
 BEGIN 

DECLARE CURRDATE DATE; 
DECLARE PREVMDATE VARCHAR(6);
DECLARE PREVYDATE VARCHAR(6);

SELECT CAST(:IN_CALMONTH||'01' AS DATE) INTO CURRDATE FROM DUMMY;
SELECT CALMONTH INTO PREVMDATE FROM "_SYS_BIC"."T/ATT_TIME_HANA" 
	WHERE DATE_SQL = ADD_MONTHS(:CURRDATE,-1);
SELECT CALMONTH INTO PREVYDATE FROM "_SYS_BIC"."T/ATT_TIME_HANA"
	WHERE DATE_SQL = ADD_YEARS(:CURRDATE,-1);

REGION = 	SELECT * FROM 
			(SELECT	EMPRESA, REGION1, SUBREGION, HUB, CIUDAD, CATEGORIA
			FROM "_SYS_BIC"."T.ROAMBI_A/ANA_ORDERS_A" 
			WHERE CALMONTH = :IN_CALMONTH
 	 		OR ATT_TIME_HANA_2_CALMONTH = :IN_CALMONTH
 	 		OR ATT_TIME_HANA_3_CALMONTH = :IN_CALMONTH)
 	 		,  
 	 		(SELECT 	YEAR, MONTH, DAY, DATE_SQL, CALMONTH 
 	 		FROM  "_SYS_BIC"."T/ATT_TIME_HANA") 	 		
 	 		;
ACTUAL =
	SELECT  EMPRESA, 'UNITY' AS TIPO, REGION1 AS REGION, COALESCE("SUBREGION",'ND') AS SUBREGION, 
			COALESCE("HUB",'ND') AS HUB, COALESCE("CIUDAD",'ND') AS CIUDAD, "YEAR", "MONTH", 
			"DAY", "DATE_SQL" AS "FECHA", "CALMONTH", COALESCE("CATEGORIA",'ND') AS CATEGORIA,
			0 AS VENTA_NETA, 0 AS VENTA_TOTAL, 0 AS SERVICIOS_VENTAS, 0 AS INSTALACIONES, 
			0 AS SERVICIOS_INSTALACIONES
			FROM :REGION 
			WHERE CALMONTH = :IN_CALMONTH
	UNION ALL		
	SELECT "EMPRESA", 'UNITY' AS "TIPO", "REGION1" AS REGION, COALESCE("SUBREGION",'ND') AS SUBREGION, 
			COALESCE("HUB",'ND') AS HUB, COALESCE("CIUDAD",'ND') AS CIUDAD, "YEAR", "MONTH", 
			"DAY", "DATE_SQL" AS "FECHA", "CALMONTH", COALESCE("CATEGORIA",'ND') AS CATEGORIA,
 	 		SUM(COALESCE(VENTA_NETA,0)) AS VENTA_NETA,
 	 		SUM(COALESCE(VENTA_TOTAL,0)) AS VENTA_TOTAL,
 	 		0 AS SERVICIOS_VENTAS,
 	 		SUM(COALESCE(INSTALACIONES,0)) AS INSTALACIONES,
 	 		0 AS SERVICIOS_INSTALACIONES
 	 FROM 	"_SYS_BIC"."T.ROAMBI_A/ANA_ORDERS_A"
 	 WHERE CALMONTH = :IN_CALMONTH
 	 GROUP BY "EMPRESA", "REGION1", COALESCE("SUBREGION",'ND'), COALESCE("HUB",'ND'), COALESCE("CIUDAD",'ND'), 
 			"YEAR", "MONTH", "DAY", "DATE_SQL", "CALMONTH", COALESCE("CATEGORIA",'ND')
	UNION ALL
 	SELECT EMPRESA, 'UNITY' AS TIPO, REGION1 AS REGION, SUBREGION, HUB, CIUDAD, YEAR, MONTH, DAY,
 	 		DATE_SQL AS FECHA, CALMONTH, TIPO_SERVICIO AS CATEGORIA,
			0 AS VENTA_NETA,
 	 		0 AS VENTA_TOTAL,
 	 		SUM(COALESCE(SERVICIOS_VENTAS,0)) AS SERVICIOS_VENTAS,
 	 		0 AS INSTALACIONES,
 	 		SUM(COALESCE(SERVICIOS_INSTALACIONES,0)) AS SERVICIOS_INSTALACIONES 	 	
 	 	FROM "_SYS_BIC"."T.ROAMBI_A/CA_BUDGET_A" 
 	 	WHERE CALMONTH = :IN_CALMONTH
 	 	GROUP BY EMPRESA, REGION1, SUBREGION, HUB, CIUDAD, YEAR, MONTH, DAY, DATE_SQL, CALMONTH,
 	 	TIPO_SERVICIO
; 	 


ANTERIOR =
	SELECT  EMPRESA, 'UNITY' AS TIPO, REGION1 AS REGION, COALESCE("SUBREGION",'ND') AS SUBREGION, 
			COALESCE("HUB",'ND') AS HUB, COALESCE("CIUDAD",'ND') AS CIUDAD, "YEAR", "MONTH", 
			"DAY", "DATE_SQL" AS "FECHA", "CALMONTH", COALESCE("CATEGORIA",'ND') AS CATEGORIA,
			0 AS VENTA_NETA, 0 AS VENTA_TOTAL, 0 AS SERVICIOS_VENTAS, 0 AS INSTALACIONES, 
			0 AS SERVICIOS_INSTALACIONES
			FROM :REGION 
			WHERE CALMONTH = :PREVMDATE
	UNION ALL		
	SELECT "EMPRESA", 'UNITY' AS "TIPO", "REGION1" AS REGION, COALESCE("SUBREGION",'ND') AS SUBREGION, 
			COALESCE("HUB",'ND') AS HUB, COALESCE("CIUDAD",'ND') AS CIUDAD, "YEAR", "MONTH", 
			"DAY", "DATE_SQL" AS "FECHA", "CALMONTH", COALESCE("CATEGORIA",'ND') AS CATEGORIA,
 	 		SUM(COALESCE(VENTA_NETA,0)) AS VENTA_NETA,
 	 		SUM(COALESCE(VENTA_TOTAL,0)) AS VENTA_TOTAL,
 	 		0 AS SERVICIOS_VENTAS,
 	 		SUM(COALESCE(INSTALACIONES,0)) AS INSTALACIONES,
 	 		0 AS SERVICIOS_INSTALACIONES
 	 FROM 	"_SYS_BIC"."T.ROAMBI_A/ANA_ORDERS_A"
 	 WHERE ATT_TIME_HANA_2_CALMONTH = :IN_CALMONTH
 	 GROUP BY "EMPRESA", "REGION1", COALESCE("SUBREGION",'ND'), COALESCE("HUB",'ND'), COALESCE("CIUDAD",'ND'), 
 			"YEAR", "MONTH", "DAY", "DATE_SQL", "CALMONTH", COALESCE("CATEGORIA",'ND')
 	UNION ALL
	SELECT EMPRESA, 'UNITY' AS TIPO, REGION1 AS REGION, SUBREGION, HUB, CIUDAD, A.YEAR, A.MONTH, A.DAY,
 	 	A.DATE_SQL AS FECHA, A.CALMONTH, TIPO_SERVICIO AS CATEGORIA,
 	 		0 AS VENTA_NETA,
 	 		0 AS VENTA_TOTAL,
 	 		SUM(COALESCE(SERVICIOS_VENTAS,0)) AS SERVICIOS_VENTAS,
 	 		0 AS INSTALACIONES,
 	 		SUM(COALESCE(SERVICIOS_INSTALACIONES,0)) AS SERVICIOS_INSTALACIONES
 	 		FROM "_SYS_BIC"."T.ROAMBI_A/CA_BUDGET_A" AS A 	
 	 		INNER JOIN "_SYS_BIC"."T/ATT_TIME_HANA" AS B
 	 		ON ADD_MONTHS(A.DATE_SQL,1) = B.DATE_SQL
 	 		WHERE B.CALMONTH = :IN_CALMONTH
 	 		GROUP BY EMPRESA, REGION1, SUBREGION, HUB, CIUDAD, A.YEAR, A.MONTH, A.DAY, A.DATE_SQL, A.CALMONTH, TIPO_SERVICIO 	 		 
;

PREV_YEAR =
	SELECT  EMPRESA, 'UNITY' AS TIPO, REGION1 AS REGION, COALESCE("SUBREGION",'ND') AS SUBREGION, 
			COALESCE("HUB",'ND') AS HUB, COALESCE("CIUDAD",'ND') AS CIUDAD, "YEAR", "MONTH", 
			"DAY", "DATE_SQL" AS "FECHA", "CALMONTH", COALESCE("CATEGORIA",'ND') AS CATEGORIA,
			0 AS VENTA_NETA, 0 AS VENTA_TOTAL, 0 AS SERVICIOS_VENTAS, 0 AS INSTALACIONES, 
			0 AS SERVICIOS_INSTALACIONES
			FROM :REGION 
			WHERE CALMONTH = :PREVYDATE
	UNION ALL
	SELECT "EMPRESA", 'UNITY' AS "TIPO", "REGION1" AS REGION, COALESCE("SUBREGION",'ND') AS SUBREGION, 
			COALESCE("HUB",'ND') AS HUB, COALESCE("CIUDAD",'ND') AS CIUDAD, "YEAR", "MONTH", 
			"DAY", "DATE_SQL" AS "FECHA", "CALMONTH", COALESCE("CATEGORIA",'ND') AS CATEGORIA,
 	 		SUM(COALESCE(VENTA_NETA,0)) AS VENTA_NETA,
 	 		SUM(COALESCE(VENTA_TOTAL,0)) AS VENTA_TOTAL,
 	 		0 AS SERVICIOS_VENTAS,
 	 		SUM(COALESCE(INSTALACIONES,0)) AS INSTALACIONES,
 	 		0 AS SERVICIOS_INSTALACIONES
 	 FROM 	"_SYS_BIC"."T.ROAMBI_A/ANA_ORDERS_A"
 	 WHERE ATT_TIME_HANA_3_CALMONTH = :IN_CALMONTH
 	 GROUP BY "EMPRESA", "REGION1", COALESCE("SUBREGION",'ND'), COALESCE("HUB",'ND'), COALESCE("CIUDAD",'ND'), 
 			"YEAR", "MONTH", "DAY", "DATE_SQL", "CALMONTH", COALESCE("CATEGORIA",'ND')
 	UNION ALL
	SELECT EMPRESA, 'UNITY' AS TIPO, REGION1 AS REGION, SUBREGION, HUB, CIUDAD, A.YEAR, A.MONTH, A.DAY,
 	 	A.DATE_SQL AS FECHA, A.CALMONTH, TIPO_SERVICIO AS CATEGORIA,
 	 		0 AS VENTA_NETA,
 	 		0 AS VENTA_TOTAL,
 	 		SUM(COALESCE(SERVICIOS_VENTAS,0)) AS SERVICIOS_VENTAS,
 	 		0 AS INSTALACIONES,
 	 		SUM(COALESCE(SERVICIOS_INSTALACIONES,0)) AS SERVICIOS_INSTALACIONES
 	 		FROM "_SYS_BIC"."T.ROAMBI_A/CA_BUDGET_A" AS A 	
 	 		INNER JOIN "_SYS_BIC"."T/ATT_TIME_HANA" AS B
 	 		ON ADD_YEARS(A.DATE_SQL,1) = B.DATE_SQL
 	 		WHERE B.CALMONTH = :IN_CALMONTH
 	 		GROUP BY EMPRESA, REGION1, SUBREGION, HUB, CIUDAD, A.YEAR, A.MONTH, A.DAY, A.DATE_SQL, A.CALMONTH, TIPO_SERVICIO 	 		 
;


var_out = 
	SELECT DISTINCT "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "YEAR", "MONTH", "DAY", "FECHA", "CALMONTH", "CATEGORIA",
	 SUM(VENTA_NETA) OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA" ORDER BY "FECHA" ASC) AS "VENTA_NETA",
	 SUM(VENTA_TOTAL) OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA" ORDER BY "FECHA" ASC) AS "VENTA_TOTAL",
	 0 AS "VENTA_NETA_PM", 
	 0 AS "VENTA_TOTAL_PM",
	 0 AS "VENTA_NETA_PY",
	 0 AS "VENTA_TOTAL_PY",
	 SUM(SERVICIOS_VENTAS) OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA" ORDER BY "FECHA" ASC) AS "SERVICIOS_VENTAS",
	 SUM(INSTALACIONES) OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA" ORDER BY "FECHA" ASC) AS "INSTALACIONES",
	 0 AS "INSTALACIONES_PM",
	 0 AS "INSTALACIONES_PY",
	 SUM(SERVICIOS_INSTALACIONES) OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA" ORDER BY "FECHA" ASC) AS "SERVICIOS_INSTALACIONES"
	FROM (
		SELECT "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "YEAR", "MONTH", "DAY", "FECHA", "CALMONTH", "CATEGORIA", 
		"VENTA_NETA", "VENTA_TOTAL", "SERVICIOS_VENTAS", "INSTALACIONES", "SERVICIOS_INSTALACIONES"
		FROM :ACTUAL
		UNION ALL	
		SELECT "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", B."YEAR", B."MONTH",B."DAY",B."DATE_SQL" AS "FECHA", B."CALMONTH", "CATEGORIA", 
		0 AS VENTA_NETA, 0 AS VENTA_TOTAL, 0 AS SERVICIOS_VENTAS, 0 AS INSTALACIONES, 0 AS SERVICIOS_INSTALACIONES
		FROM :ACTUAL A INNER JOIN "_SYS_BIC"."T/ATT_TIME_HANA" B
		ON A.CALMONTH = B.CALMONTH 
	)
	UNION ALL
	SELECT DISTINCT "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "YEAR", "MONTH", "DAY",  "FECHA", "CALMONTH", "CATEGORIA",
		0 AS "VENTA_NETA",
		0 AS "VENTA_TOTAL",
		SUM(VENTA_NETA) OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA" ORDER BY "FECHA" ASC) AS "VENTA_NETA_PM",
		SUM(VENTA_TOTAL) OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA" ORDER BY "FECHA" ASC) AS "VENTA_TOTAL_PM",
		0 AS "VENTA_NETA_PY",
		0 AS "VENTA_TOTAL_PY",
		SUM(SERVICIOS_VENTAS) OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA" ORDER BY "FECHA" ASC) AS "SERVICIOS_VENTAS",
		0 AS "INSTALACIONES",
		SUM(INSTALACIONES) OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA" ORDER BY "FECHA" ASC) AS "INSTALACIONES_PM",
	 	0 AS "INSTALACIONES_PY",
		SUM(SERVICIOS_INSTALACIONES) OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA" ORDER BY "FECHA" ASC) AS "SERVICIOS_INSTALACIONES"
	FROM (
		SELECT "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "YEAR", "MONTH", "DAY", "FECHA", "CALMONTH", "CATEGORIA", "VENTA_NETA", "VENTA_TOTAL","SERVICIOS_VENTAS",
		"INSTALACIONES", "SERVICIOS_INSTALACIONES"
		FROM :ANTERIOR
		UNION ALL
		SELECT DISTINCT "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", B."YEAR", B."MONTH", B."DAY", B."DATE_SQL" AS FECHA, B."CALMONTH", "CATEGORIA",
		0 AS "VENTA_NETA", 0 AS "VENTA_NETA", 0 AS "SERVICIOS_VENTAS", 0 AS INSTALACIONES, 0 AS SERVICIOS_INSTALACIONES
		FROM :ANTERIOR A INNER JOIN "_SYS_BIC"."T/ATT_TIME_HANA" B
		ON A.CALMONTH = B.CALMONTH
		)
	UNION ALL
	SELECT DISTINCT "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "YEAR", "MONTH", "DAY",  "FECHA", "CALMONTH", "CATEGORIA",
		0 AS "VENTA_NETA",
		0 AS "VENTA_TOTAL",
		0 AS "VENTA_NETA_PM",
		0 AS "VENTA_TOTAL_PM",
		SUM(VENTA_NETA) OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA" ORDER BY "FECHA" ASC) AS "VENTA_NETA_PY",
		SUM(VENTA_TOTAL) OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA" ORDER BY "FECHA" ASC) AS "VENTA_TOTAL_PY",
		SUM(SERVICIOS_VENTAS) OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA" ORDER BY "FECHA" ASC) AS "SERVICIOS_VENTAS",
		0 AS "INSTALACIONES",
		0 AS "INSTALACIONES_PM",
		SUM(INSTALACIONES) OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA" ORDER BY "FECHA" ASC) AS "INSTALACIONES_PY",
		SUM(SERVICIOS_INSTALACIONES) OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA" ORDER BY "FECHA" ASC) AS "SERVICIOS_INSTALACIONES"
	FROM (
		SELECT "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "YEAR", "MONTH", "DAY", "FECHA", "CALMONTH", "CATEGORIA", "VENTA_NETA", "VENTA_TOTAL", "SERVICIOS_VENTAS",
		"INSTALACIONES", "SERVICIOS_INSTALACIONES"
		FROM :PREV_YEAR
		UNION ALL
		SELECT DISTINCT "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", B."YEAR", B."MONTH", B."DAY", B."DATE_SQL" AS FECHA, B."CALMONTH", "CATEGORIA",
		0 AS "VENTA_NETA", 0 AS "VENTA_NETA", 0 AS "SERVICIOS_VENTAS", 0 AS INSTALACIONES, 0 AS SERVICIOS_INSTALACIONES
		FROM :PREV_YEAR A INNER JOIN "_SYS_BIC"."T/ATT_TIME_HANA" B
		ON A.CALMONTH = B.CALMONTH
		)
;
END 
/********* End Procedure Script ************/