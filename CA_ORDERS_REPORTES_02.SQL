
 /********* Begin Procedure Script ************/

BEGIN

ACTUAL =
SELECT "EMPRESA", COALESCE("TIPO",'LEGACY') AS "TIPO", "REGION", COALESCE("SUBREGION",'ND') AS SUBREGION, COALESCE("HUB",'ND') AS HUB, COALESCE("CIUDAD",'ND') AS CIUDAD, COALESCE(PLAY_CLI, 'ND') AS PLAY_CLI,
	"YEAR", "MONTH", "DAY", "FECHA", "CALMONTH", COALESCE("CATEGORIA",'ND') AS CATEGORIA,
	COALESCE(sum("CANCELACIONES_VOLUNTARIAS_TOTALES"),0) AS "CANCELACIONES_VOLUNTARIAS_TOTALES",
	COALESCE(sum("RECONEXIONES"),0) AS "RECONEXIONES",
	COALESCE(sum("INSTALACIONES"),0) AS "INSTALACIONES",
	COALESCE(sum("CANCELACION_BRUTA"),0) AS "CANCELACION_BRUTA",
	COALESCE(sum("CANCELACION_NETA"),0) AS "CANCELACION_NETA",
	COALESCE(sum("CANCELACIONES"),0) AS "CANCELACIONES"
FROM "_SYS_BIC"."T.REPORTES02/ANA_ORDERS_REPORTES_02" A LEFT OUTER JOIN "_SYS_BIC"."T.REPORTES02/ATT_CAT_CLIENTE_MIGRADO" B
ON A.ID_EMPRESA=B.ORIG_ID AND A.CLIENTE=B.CLIENTE_ID AND A.FECHA BETWEEN FECHA_INICIO AND FECHA_FIN
WHERE CALMONTH=:I_CALMONTH
GROUP BY "EMPRESA", COALESCE("SUBREGION",'ND'), COALESCE("HUB",'ND'), COALESCE("CIUDAD",'ND'), "YEAR", "MONTH", "DAY", "FECHA", "CALMONTH", COALESCE("TIPO",'LEGACY'), COALESCE("CATEGORIA",'ND'), "REGION", COALESCE(PLAY_CLI,'ND')
;

ANTERIOR =
SELECT "EMPRESA", COALESCE("TIPO",'LEGACY') AS "TIPO", "REGION", COALESCE("SUBREGION",'ND') AS SUBREGION, COALESCE("HUB",'ND') AS HUB, COALESCE("CIUDAD",'ND') AS CIUDAD, COALESCE(PLAY_CLI,'ND') AS PLAY_CLI,
	"YEAR", "MONTH", "DAY", "FECHA", "CALMONTH", COALESCE("CATEGORIA",'ND') AS CATEGORIA,
	COALESCE(sum("CANCELACIONES_VOLUNTARIAS_TOTALES"),0) AS "CANCELACIONES_VOLUNTARIAS_TOTALES",
	COALESCE(sum("RECONEXIONES"),0) AS "RECONEXIONES",
	COALESCE(sum("INSTALACIONES"),0) AS "INSTALACIONES",
	COALESCE(sum("CANCELACION_BRUTA"),0) AS "CANCELACION_BRUTA",
	COALESCE(sum("CANCELACION_NETA"),0) AS "CANCELACION_NETA",
	COALESCE(sum("CANCELACIONES"),0) AS "CANCELACIONES"
FROM "_SYS_BIC"."T.REPORTES02/ANA_ORDERS_REPORTES_02" A LEFT OUTER JOIN "_SYS_BIC"."T.REPORTES02/ATT_CAT_CLIENTE_MIGRADO" B
ON A.ID_EMPRESA=B.ORIG_ID AND A.CLIENTE=B.CLIENTE_ID AND A.FECHA BETWEEN FECHA_INICIO AND FECHA_FIN
WHERE ATT_TIME_HANA_2_CALMONTH=:I_CALMONTH
GROUP BY "EMPRESA", COALESCE("SUBREGION",'ND'), COALESCE("HUB",'ND'), COALESCE("CIUDAD",'ND'), "YEAR", "MONTH", "DAY", "FECHA", "CALMONTH", COALESCE("TIPO",'LEGACY'), COALESCE("CATEGORIA",'ND'), "REGION", COALESCE(PLAY_CLI,'ND')
;

var_out =
SELECT DISTINCT "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "YEAR", "MONTH", "DAY", "FECHA", "CALMONTH", "CATEGORIA", PLAY_CLI,
	sum("CANCELACIONES_VOLUNTARIAS_TOTALES") OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA", PLAY_CLI ORDER BY "FECHA" ASC) AS "CANCELACIONES_VOLUNTARIAS_TOTALES",
	sum("RECONEXIONES") OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA", PLAY_CLI ORDER BY "FECHA" ASC) AS "RECONEXIONES",
	sum("INSTALACIONES") OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA", PLAY_CLI ORDER BY "FECHA" ASC) AS "INSTALACIONES",
	sum("CANCELACION_BRUTA") OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA", PLAY_CLI ORDER BY "FECHA" ASC) AS "CANCELACION_BRUTA",
	sum("CANCELACION_NETA") OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA", PLAY_CLI ORDER BY "FECHA" ASC) AS "CANCELACION_NETA",
	NULL AS "CANCELACIONES_VOLUNTARIAS_TOTALES_PM",
	NULL AS "RECONEXIONES_PM",
	NULL AS "INSTALACIONES_PM",
	NULL AS "CANCELACION_BRUTA_PM",
	NULL AS "CANCELACION_NETA_PM",
    SUM("CANCELACIONES") OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA", PLAY_CLI ORDER BY "FECHA" ASC) AS "CANCELACIONES",
    NULL AS CANCELACIONES_PM
FROM (
SELECT "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "YEAR", "MONTH", "DAY", "FECHA", "CALMONTH", "CATEGORIA", PLAY_CLI,
	"CANCELACIONES_VOLUNTARIAS_TOTALES", "RECONEXIONES", "INSTALACIONES", "CANCELACION_BRUTA", "CANCELACION_NETA", "CANCELACIONES"
FROM :ACTUAL
UNION ALL
SELECT DISTINCT "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", B."YEAR", B."MONTH", B."DAY", B.DATE_SQL AS "FECHA", B."CALMONTH", "CATEGORIA", PLAY_CLI,
	0 AS "CANCELACIONES_VOLUNTARIAS_TOTALES", 0 AS "RECONEXIONES", 0 AS "INSTALACIONES", 0 AS "CANCELACION_BRUTA", 0 AS "CANCELACION_NETA", 0 AS CANCELACIONES
FROM :ACTUAL A INNER JOIN "_SYS_BIC"."T/ATT_TIME_HANA" B
ON A.CALMONTH=B.CALMONTH
)
UNION ALL
SELECT DISTINCT "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "YEAR", "MONTH", "DAY", "FECHA", "CALMONTH", "CATEGORIA", PLAY_CLI,
	NULL AS "CANCELACIONES_VOLUNTARIAS_TOTALES",
	NULL AS "RECONEXIONES",
	NULL AS "INSTALACIONES",
	NULL AS "CANCELACION_BRUTA",
	NULL AS "CANCELACION_NETA",
	sum("CANCELACIONES_VOLUNTARIAS_TOTALES") OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA", PLAY_CLI ORDER BY "FECHA" ASC) AS "CANCELACIONES_VOLUNTARIAS_TOTALES_PM",
	sum("RECONEXIONES") OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA", PLAY_CLI ORDER BY "FECHA" ASC) AS "RECONEXIONES_PM",
	sum("INSTALACIONES") OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA", PLAY_CLI ORDER BY "FECHA" ASC) AS "INSTALACIONES_PM",
	sum("CANCELACION_BRUTA") OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA", PLAY_CLI ORDER BY "FECHA" ASC) AS "CANCELACION_BRUTA_PM",
	sum("CANCELACION_NETA") OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA", PLAY_CLI ORDER BY "FECHA" ASC) AS "CANCELACION_NETA_PM",
	NULL AS CANCELACIONES,
	sum("CANCELACIONES") OVER (PARTITION BY "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "CATEGORIA", PLAY_CLI ORDER BY "FECHA" ASC) AS "CANCELACIONES_PM"
FROM (
SELECT "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", "YEAR", "MONTH", "DAY", "FECHA", "CALMONTH", "CATEGORIA", PLAY_CLI,
	"CANCELACIONES_VOLUNTARIAS_TOTALES", "RECONEXIONES", "INSTALACIONES", "CANCELACION_BRUTA", "CANCELACION_NETA", CANCELACIONES
FROM :ANTERIOR
UNION ALL
SELECT DISTINCT "EMPRESA", "TIPO", "REGION", "SUBREGION", "HUB", "CIUDAD", B."YEAR", B."MONTH", B."DAY", B.DATE_SQL AS "FECHA", B."CALMONTH", "CATEGORIA", PLAY_CLI,
	0 AS "CANCELACIONES_VOLUNTARIAS_TOTALES", 0 AS "RECONEXIONES", 0 AS "INSTALACIONES", 0 AS "CANCELACION_BRUTA", 0 AS "CANCELACION_NETA", 0 AS CANCELACIONES
FROM :ANTERIOR A INNER JOIN "_SYS_BIC"."T/ATT_TIME_HANA" B
ON A.CALMONTH=B.CALMONTH
)

;

END /********* End Procedure Script ************/
