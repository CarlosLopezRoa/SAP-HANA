 
 /********* Begin Procedure Script ************/ 
 BEGIN 
CLIENTES =
SELECT A.ORIG_ID, CLIENTE, VIDEO||INTERNET||TELEFONIA AS PLAY_CLI, FECHA, CLIENTES, 0 AS PERDIDAS,
	CASE 
		WHEN COALESCE(REGION,'ND')='ND' AND A.ORIG_ID IN (1,2) THEN 'INTERIOR'
		WHEN COALESCE(REGION,'ND')='ND' AND A.ORIG_ID IN (3) THEN 'METROPOLITANA'
		ELSE REGION END AS REGION, COALESCE(SUBREGION,'ND') AS SUBREGION, COALESCE(HUB,'ND') AS HUB, COALESCE(CIUDAD,'ND') AS CIUDAD,
	CASE
		WHEN A.ORIG_ID IN (1,2) THEN 'LEGACY'
		WHEN A.ORIG_ID=3 AND FECHA BETWEEN '2014-10-01' AND '2014-10-31' THEN 'LEGACY' --FILTRO LUIS
		WHEN A.ORIG_ID=3 AND REGION='INTERIOR' AND FECHA BETWEEN '2014-10-01' AND '2014-12-31' THEN 'LEGACY' --FILTRO LUIS
		WHEN C.TIPO IS NULL AND A.ORIG_ID=3 AND FECHA>'2014-11-10' THEN 'IZZI'
		WHEN C.TIPO IS NULL AND A.ORIG_ID=3 AND FECHA<='2014-11-10' THEN 'LEGACY'
		WHEN C.TIPO='UNITY' THEN 'IZZI'
		ELSE TIPO END AS TIPO,
	CAST(YEAR(FECHA)*100+MONTH(FECHA) AS NVARCHAR(6)) AS COSECHA,
	CAST(YEAR(FECHA)*100+MONTH(FECHA) AS NVARCHAR(6)) AS MES, 0 AS TRANSVERSAL
FROM(
	SELECT DISTINCT ORIG_ID, CLIENTE, MAX(ID_REGION) OVER (PARTITION BY ORIG_ID, CLIENTE, FECHA) AS ID_REGION, 1 AS CLIENTES, 
	MAX(CASE WHEN CATEGORIA='VIDEO' THEN 'V' ELSE '' END) OVER (PARTITION BY ORIG_ID, CLIENTE, FECHA) AS VIDEO,
	MAX(CASE WHEN CATEGORIA='INTERNET' THEN 'I' ELSE '' END) OVER (PARTITION BY ORIG_ID, CLIENTE, FECHA) AS INTERNET,
	MAX(CASE WHEN CATEGORIA IN ('TELEFONIA FIJA','TELEFONIA') THEN 'T' ELSE '' END) OVER (PARTITION BY ORIG_ID, CLIENTE, FECHA) AS TELEFONIA,
	FECHA, MIN(FECHA) OVER (PARTITION BY ORIG_ID, CLIENTE) AS F1
	FROM T2.HANA_STG1_ORDERS
	WHERE ORIG_ID IN (1,2,3) AND INSTALACIONES IS NOT NULL
) A LEFT OUTER JOIN (
	SELECT ID, ORIG_ID, REGION, SUBREGION, HUB, CIUDAD
	FROM T1.HANA_STG1_DIM_REGION
	WHERE ORIG_ID IN (1,2,3)
) B
ON A.ORIG_ID=B.ORIG_ID AND A.ID_REGION=B.ID
LEFT OUTER JOIN (
	SELECT DISTINCT ORIG_ID, CLIENTE_ID, MIN(TIPO) AS TIPO FROM T1.HANA_STG1_CAT_CLIENTE_MIGRADO GROUP BY ORIG_ID, CLIENTE_ID
) C
ON A.ORIG_ID=C.ORIG_ID AND C.CLIENTE_ID=A.CLIENTE
WHERE FECHA=F1 AND FECHA>='2014-10-01' AND CAST(YEAR(FECHA)*100+MONTH(FECHA) AS NVARCHAR(6)) BETWEEN :IN_CALMONTH_FROM AND :IN_CALMONTH_TO
;

DXXM =
SELECT DISTINCT B.ORIG_ID, B.CLIENTE, B.TIPO, B.PLAY_CLI, B.REGION, B.SUBREGION, B.HUB, B.CIUDAD, A.FECHA, 0 AS CLIENTES, 1 AS PERDIDAS,
	COSECHA,
	CAST(YEAR(A.FECHA)*100+MONTH(A.FECHA) AS NVARCHAR(6)) AS MES, (YEAR(A.FECHA)*12+MONTH(A.FECHA))-(YEAR(B.FECHA)*12+MONTH(B.FECHA)) AS TRANSVERSAL
FROM T2.HANA_STG1_RGU A INNER JOIN :CLIENTES B
ON A.ORIG_ID=B.ORIG_ID AND A.CLIENTE=B.CLIENTE AND B.FECHA<=A.FECHA
WHERE NO_DX_3M IS NOT NULL AND A.FECHA>'2014-10-01'
;

SEGUIMIENTO =
SELECT CASE WHEN ORIG_ID=3 THEN 'CABLEVISION' ELSE 'CABLEMAS' END AS EMPRESA, TIPO, PLAY_CLI, REGION, SUBREGION, HUB, CIUDAD, COSECHA, MES, TRANSVERSAL, 
	SUM(CLIENTES) AS CLIENTES, SUM(PERDIDAS) AS PERDIDAS
FROM(
	SELECT ORIG_ID, CLIENTE, TIPO, PLAY_CLI, REGION, SUBREGION, HUB, CIUDAD, FECHA, COSECHA, MES, TRANSVERSAL, CLIENTES, PERDIDAS
	FROM :CLIENTES
	UNION ALL
	SELECT DISTINCT B.ORIG_ID, B.CLIENTE, B.TIPO, B.PLAY_CLI, B.REGION, B.SUBREGION, B.HUB, B.CIUDAD, A.FECHA, B.COSECHA, 
		CAST(YEAR(A.FECHA)*100+MONTH(A.FECHA) AS NVARCHAR(6)) AS MES, (YEAR(A.FECHA)*12+MONTH(A.FECHA))-(YEAR(B.FECHA)*12+MONTH(B.FECHA)) AS TRANSVERSAL, 
		0 AS CLIENTES, 1 AS PERDIDAS
	FROM T2.HANA_STG1_ORDERS A INNER JOIN :CLIENTES B
	ON A.ORIG_ID=B.ORIG_ID AND A.CLIENTE=B.CLIENTE AND B.FECHA<=A.FECHA
	WHERE NO_CANCELACIONES_VOLUNTARIAS_TOTALES IS NOT NULL AND A.FECHA>'2014-10-01'
	UNION ALL
	SELECT ORIG_ID, CLIENTE, TIPO, PLAY_CLI, REGION, SUBREGION, HUB, CIUDAD, FECHA, COSECHA, MES, TRANSVERSAL, CLIENTES, PERDIDAS
	FROM :DXXM
	UNION ALL
	SELECT DISTINCT B.ORIG_ID, B.CLIENTE, B.TIPO, B.PLAY_CLI, B.REGION, B.SUBREGION, B.HUB, B.CIUDAD, MIN(A.FECHA) AS FECHA, B.COSECHA, 
		CAST(YEAR(MIN(A.FECHA))*100+MONTH(MIN(A.FECHA)) AS NVARCHAR(6)) AS MES, 
		(YEAR(MIN(A.FECHA))*12+MONTH(MIN(A.FECHA)))-(YEAR(B.FECHA)*12+MONTH(B.FECHA))+B.TRANSVERSAL AS TRANSVERSAL, 0 AS CLIENTES, -1 AS PERDIDAS
	FROM T2.HANA_STG1_ORDERS A INNER JOIN :DXXM B
	ON A.ORIG_ID=B.ORIG_ID AND A.CLIENTE=B.CLIENTE AND A.FECHA>B.FECHA
	WHERE NO_RECONEXIONES IS NOT NULL AND A.FECHA>'2014-10-01'
	GROUP BY B.ORIG_ID, B.CLIENTE, B.PLAY_CLI, B.REGION, B.SUBREGION, B.HUB, B.CIUDAD, B.COSECHA, B.FECHA, B.TIPO, B.TRANSVERSAL
)
GROUP BY CASE WHEN ORIG_ID=3 THEN 'CABLEVISION' ELSE 'CABLEMAS' END, TIPO, PLAY_CLI, REGION, SUBREGION, HUB, CIUDAD, COSECHA, MES, TRANSVERSAL
;

var_out = 
SELECT EMPRESA, REGION, SUBREGION, HUB, CIUDAD, PLAY_CLI AS PLAY, TIPO, COSECHA AS MES_INSTALACION, MES AS MES_PERDIDAS, TRANSVERSAL, CLIENTES AS INSTALACIONES, 
	PERDIDAS, SUM(PERDIDAS) OVER (PARTITION BY EMPRESA, TIPO, PLAY_CLI, REGION, SUBREGION, HUB, CIUDAD, COSECHA ORDER BY TRANSVERSAL ASC) AS PERDIDAS_ACUMULADO
FROM(
	SELECT EMPRESA, TIPO, PLAY_CLI, REGION, SUBREGION, HUB, CIUDAD, COSECHA, MES, TRANSVERSAL, SUM(CLIENTES) AS CLIENTES, SUM(PERDIDAS) AS PERDIDAS
	FROM(
		SELECT EMPRESA, TIPO, PLAY_CLI, REGION, SUBREGION, HUB, CIUDAD, COSECHA, MES, TRANSVERSAL, 0 AS CLIENTES, 0 AS PERDIDAS FROM
		(
			SELECT DISTINCT EMPRESA, TIPO, PLAY_CLI, REGION, SUBREGION, HUB, CIUDAD
			FROM :SEGUIMIENTO
		) A, (
			SELECT DISTINCT COSECHA, MES, TRANSVERSAL
			FROM :SEGUIMIENTO
		) B
		UNION ALL
		SELECT * FROM :SEGUIMIENTO
	)
	GROUP BY EMPRESA, TIPO, PLAY_CLI, REGION, SUBREGION, HUB, CIUDAD, COSECHA, MES, TRANSVERSAL
)
;

		
END /********* End Procedure Script ************/